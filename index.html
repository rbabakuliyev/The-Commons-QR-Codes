<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Magnolia Science Academy 5 – Lobos • Commons QR Lookup</title>
  <meta name="description" content="Enter your school email to view and download your Commons QR code." />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root{
      /* Brand + UI colors */
      --bg:#0b0f19;          /* deep navy */
      --bg2:#0f172a;         /* slate */
      --ink:#ffffff;         /* text */
      --muted:#d1d5db;       /* light slate */
      --brand:#f59e0b;       /* amber */
      --brand-dark:#b45309;  /* amber dark */
      --accent:#3b82f6;      /* blue */
      --success:#22c55e;     /* green */
      --surface:#0e1324;     /* card surface */
      --border:rgba(255,255,255,.12);
      --ring: rgba(245,158,11,.40);
    }
    *{box-sizing:border-box}
    html,body{height:100%}

    /* ==== Colorful background ==== */
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial;
      color:var(--ink);
      font-size:18px; /* bigger base text */
      background:
        radial-gradient(900px 600px at 100% -10%, rgba(59,130,246,.22), transparent 70%),
        radial-gradient(700px 500px at -10% -20%, rgba(245,158,11,.25), transparent 65%),
        linear-gradient(180deg, rgba(245,158,11,.14) 0 320px, transparent 320px 100%),
        repeating-linear-gradient(135deg, rgba(255,255,255,.04) 0 2px, transparent 2px 12px),
        var(--bg2);
      display:grid; min-height:100dvh; grid-template-rows:auto 1fr auto;
    }

    /* ==== Header ==== */
    header{
      display:flex; align-items:center; gap:16px; padding:18px 22px; border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(245,158,11,.18), rgba(245,158,11,.05) 70%, transparent);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .brand-wrap{display:flex; align-items:center; gap:12px; width:100%; max-width:1180px; margin:0 auto}
    .logo{width:56px; height:auto; filter: drop-shadow(0 6px 18px rgba(0,0,0,.55));}
    .titles{line-height:1.05}
    .school{margin:0; font-size: clamp(24px, 4.4vw, 36px); letter-spacing:.2px; font-weight:900}
    .school .lobos{color:var(--brand)}
    .sub{margin:4px 0 0; color:var(--muted); font-size:clamp(14px,2.6vw,16px)}

    /* ==== Main / Card ==== */
    main{display:grid; place-items:start center; padding:32px}
    .container{width:100%; max-width:980px}
    .card{width:100%; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid var(--border);
      border-radius:22px; padding:28px; box-shadow:0 26px 80px rgba(0,0,0,.35)}

    .section-title{display:flex; align-items:center; gap:10px; margin:0 0 12px}
    .section-title .dot{width:12px; height:12px; border-radius:999px; background:var(--brand)}
    .lead{margin:0 0 22px; color:var(--muted); font-size: clamp(16px, 2.8vw, 20px)}

    /* Username input with domain suffix */
    form{display:flex; gap:14px; flex-wrap:wrap; align-items:center}
    .email-wrap{position:relative; flex:1 1 420px}
    .input{
      width:100%; background:#0f1324; border:2px solid var(--border); color:var(--ink);
      padding:20px 18px; border-radius:16px; outline:none; font-size: clamp(18px, 3.6vw, 20px);
      min-height:60px; padding-right:210px;
    }
    .suffix{position:absolute; right:12px; top:50%; transform:translateY(-50%); color:#93c5fd; font-weight:700; pointer-events:none}
    .hint{font-size:14px; color:#9ca3af; margin-top:6px}
    .input:focus{border-color:var(--brand); box-shadow:0 0 0 8px var(--ring)}

    /* Colorful buttons */
    .btn{appearance:none; border:0; color:#111; padding:18px 26px; border-radius:16px; font-weight:900; cursor:pointer; font-size: clamp(18px, 3.6vw, 20px);
      min-height:60px; letter-spacing:.2px; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; transition: transform .02s ease-in}
    .btn:active{transform: translateY(1px)}
    .btn.primary{background:linear-gradient(180deg, var(--brand), var(--brand-dark)); box-shadow:0 8px 24px rgba(245,158,11,.35)}
    .btn.secondary{background:linear-gradient(180deg, #60a5fa, #2563eb); color:white; box-shadow:0 8px 24px rgba(37,99,235,.35)}
    .btn.neutral{background:linear-gradient(180deg, #34d399, #059669); color:white; box-shadow:0 8px 24px rgba(5,150,105,.35)}
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .divider{height:1px; background:linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent); margin:22px 0}

    .result{margin-top:10px; display:grid; gap:16px}
    .qr-wrap{display:grid; grid-template-columns: minmax(180px, 260px) 1fr; gap:26px; align-items:center; background:var(--surface); border:1px solid var(--border); border-radius:18px; padding:20px}
    img.qr{width:100%; max-width:260px; height:auto; aspect-ratio:1/1; object-fit:contain; border-radius:12px; background:#020617}
    .meta{display:grid; gap:12px}
    .row{display:grid; gap:6px}
    .key{color:var(--muted); font-size:16px}
    .value{font-weight:900; font-size:22px}
    .actions{display:flex; gap:14px; flex-wrap:wrap}

    .msg{padding:16px 18px; border-radius:14px; border:1px solid var(--border); background:var(--surface); color:var(--muted)}
    .msg.error{border-color: rgba(239,68,68,.5); color:#fecaca; background: rgba(239,68,68,.08)}

    details.security{margin-top:12px}
    code.kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#0b1221; border:1px solid rgba(255,255,255,.1); padding:2px 6px; border-radius:6px}

    footer{padding:18px 20px; color:var(--muted); font-size:14px; border-top:1px solid var(--border); text-align:center;
      background:linear-gradient(0deg, rgba(245,158,11,.14), rgba(255,255,255,0));}

    @media (max-width:720px){
      .logo{width:52px}
      .qr-wrap{grid-template-columns:1fr}
      .suffix{right:10px}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand-wrap">
      <img class="logo" src="assets/mascot.png" alt="Magnolia Science Academy 5 Lobos Mascot" />
      <div class="titles">
        <h1 class="school">Magnolia Science Academy 5 • <span class="lobos">LOBOS</span></h1>
        <p class="sub">Commons QR Lookup</p>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <section class="card" aria-labelledby="title">
        <div class="section-title"><span class="dot"></span><h2 id="title" style="margin:0">Student Access</h2></div>
        <p class="lead">Type your username or full email. We automatically add <strong>@magnoliascience.org</strong>.</p>

        <form id="lookup-form" autocomplete="off">
          <div class="email-wrap">
            <input id="email" class="input" name="email" type="text" placeholder="username or email" aria-label="Student email or username" />
            <span class="suffix" aria-hidden="true">@magnoliascience.org</span>
            <div class="hint">Example: <code class="kbd">j.doe</code> → <code class="kbd">j.doe@magnoliascience.org</code></div>
          </div>
          <button class="btn primary" id="findBtn" type="submit">Find my QR</button>
          <button class="btn secondary" id="clearBtn" type="button" title="Clear">Clear</button>
        </form>

        <div class="divider" role="presentation"></div>

        <div class="result" id="result"></div>

        <details class="security">
          <summary>Privacy note</summary>
          <div class="msg">
            This page looks up data from a local CSV file in this repository (<code class="kbd">students.csv</code>). If the repo is public, the CSV is public. Consider a private host or using hashed emails; set <code class="kbd">USE_HASH_MATCH = true</code> and add an <code class="kbd">email_hash</code> column.
          </div>
        </details>
      </section>
    </div>
  </main>

  <footer>
    © <span id="year"></span> Magnolia Science Academy 5 • Lobos
  </footer>

  <script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const form = document.getElementById('lookup-form');
    const emailInput = document.getElementById('email');
    const result = document.getElementById('result');
    const yearEl = document.getElementById('year');
    const clearBtn = document.getElementById('clearBtn');
    yearEl.textContent = new Date().getFullYear();

    // ==== CONFIG ====
    const CSV_PATH = 'students.csv';
    const USE_HASH_MATCH = false; // Set to true if your CSV has email_hash
    const SCHOOL_DOMAIN = 'magnoliascience.org';

    // Utility: SHA-256 for hash matching
    async function sha256Hex(str){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    // Normalize helpers
    const normalizeEmail = v => (v||'').trim().toLowerCase();
    function toSchoolEmail(input){
      const val = normalizeEmail(input);
      if(!val) return '';
      return val.includes('@') ? val : `${val}@${SCHOOL_DOMAIN}`;
    }

    // Try to be flexible with CSV headers
    function getFirstKey(obj, includes){
      const key = Object.keys(obj).find(k => k.toLowerCase().includes(includes));
      return key || '';
    }

    // Make awkward links (Google Drive/Dropbox) embeddable
    function normalizeUrl(u){
      const url = (u||'').trim();
      if(!url) return '';
      // Google Drive file link → direct view
      const g = url.match(/https?:\/\/drive\.google\.com\/file\/d\/([^/]+)\/view/i);
      if(g) return `https://drive.google.com/uc?export=view&id=${g[1]}`;
      const g2 = url.match(/https?:\/\/drive\.google\.com\/open\?id=([^&]+)/i);
      if(g2) return `https://drive.google.com/uc?export=view&id=${g2[1]}`;
      // Dropbox share → raw
      const d = url.match(/https?:\/\/www\.dropbox\.com\/s\/(.+)/i);
      if(d) return url.replace(/\?dl=0$/,'').replace('www.dropbox.com','dl.dropboxusercontent.com');
      return url;
    }

    // CSV cache
    let rows = [];

    function loadCSV(){
      return new Promise((resolve,reject)=>{
        Papa.parse(CSV_PATH, { header:true, download:true, skipEmptyLines:true,
          complete: (res)=> resolve(res.data), error: (err)=> reject(err)
        });
      });
    }

    function renderMessage(text, kind='info'){
      result.innerHTML = `<div class="msg ${kind==='error'?'error':''}">${text}</div>`;
    }

    function renderQR({ name, email, qr_url }){
      const safeName = name || '(No name)';
      const safeEmail = email || '';
      const url = normalizeUrl(qr_url || '');

      if(!url){
        renderMessage('Match found, but QR URL is empty in CSV for this student.', 'error');
        return;
      }

      result.innerHTML = `
        <div class="qr-wrap">
          <img class="qr" id="qrImg" alt="QR code for ${safeName}" referrerpolicy="no-referrer" src="${url}" />
          <div class="meta">
            <div class="row"><span class="key">Name</span><div class="value">${safeName}</div></div>
            <div class="row"><span class="key">Email</span><div class="value">${safeEmail}</div></div>
            <div class="actions">
              <a class="btn primary" id="downloadBtn" href="${url}" target="_blank" rel="noopener noreferrer">Open in New Tab</a>
              <button class="btn secondary" id="copyBtn" type="button">Copy Link</button>
              <button class="btn neutral" id="printBtn" type="button">Print</button>
            </div>
          </div>
        </div>`;

      // Handle broken image sources gracefully
      const img = document.getElementById('qrImg');
      img.onerror = () => {
        renderMessage('We found your record, but the QR image could not be loaded. Check that the URL is public and uses HTTPS.', 'error');
      };

      document.getElementById('copyBtn').onclick = async () => {
        try { await navigator.clipboard.writeText(url); toast('Link copied!'); } catch { toast('Unable to copy', true); }
      };
      document.getElementById('printBtn').onclick = () => {
        const w = window.open('', 'PRINT', 'height=700,width=540');
        const img = `<img src="${url}" style="width:100%;max-width:520px" />`;
        w.document.write(`<html><head><title>${safeName} QR</title><meta name='viewport' content='width=device-width, initial-scale=1' /></head><body style=\"margin:0;display:grid;place-items:center\">${img}</body></html>`);
        w.document.close(); w.focus(); w.print(); w.close();
      };
    }

    function toast(text, isError=false){
      const el = document.createElement('div');
      el.textContent = text;
      el.style.cssText = `position:fixed;left:50%;bottom:24px;transform:translateX(-50%);padding:12px 16px;border-radius:12px;background:${isError?'#7f1d1d':'#065f46'};color:white;z-index:9999;opacity:0;transition:opacity .2s;font-weight:700`;
      document.body.appendChild(el);
      requestAnimationFrame(()=>{ el.style.opacity = 1; });
      setTimeout(()=>{ el.style.opacity = 0; setTimeout(()=>el.remove(), 250); }, 1500);
    }

    async function ensureDataLoaded(){
      if(rows.length) return rows;
      try{
        const raw = await loadCSV();
        // Lowercase/trim keys and values
        rows = raw.map(r=>{
          const obj={};
          for(const k in r) obj[k.trim().toLowerCase()] = (r[k] ?? '').toString().trim();
          return obj;
        });
        return rows;
      }catch(e){
        console.error(e);
        renderMessage('Could not load students.csv. Ensure it is in the same folder and public to GitHub Pages.', 'error');
        throw e;
      }
    }

    async function findRecord(input){
      const list = await ensureDataLoaded();
      const email = toSchoolEmail(input);
      if(!email) return null;

      // Flexible column names
      const sample = list[0] || {};
      const emailKey = getFirstKey(sample, 'email') || 'email';
      const nameKey  = getFirstKey(sample, 'name')  || 'name';
      let qrKey = Object.keys(sample).find(k => /qr|code/.test(k));
      qrKey = (qrKey || 'qr_url');

      let row;
      if(USE_HASH_MATCH){
        const hash = await sha256Hex(email);
        const hashKey = getFirstKey(sample, 'email_hash') || 'email_hash';
        row = list.find(r => (r[hashKey]||'').toLowerCase() === hash);
      } else {
        row = list.find(r => normalizeEmail(r[emailKey]) === normalizeEmail(email));
      }

      if(!row) return null;
      return { name: row[nameKey], email, qr_url: row[qrKey] };
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      result.innerHTML = '';
      const findBtn = document.getElementById('findBtn');
      findBtn.disabled = true; findBtn.textContent = 'Looking…';
      try{
        const rec = await findRecord(emailInput.value);
        if(!rec){ renderMessage('No match. Try your full email or check spelling.', 'error'); return; }
        renderQR(rec);
      } finally {
        findBtn.disabled = false; findBtn.textContent = 'Find my QR';
      }
    });

    clearBtn.addEventListener('click', ()=>{
      emailInput.value = '';
      result.innerHTML = '';
      emailInput.focus();
    });
  </script>
</body>
</html>
